name: Daily SFTP Feed Sync

on:
  schedule:
    # Run daily at 6 AM UTC (1 AM Eastern)
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub UI

jobs:
  sync-feed:
    runs-on: ubuntu-latest

    steps:
      - name: Download feed from SFTP
        run: |
          pip install paramiko

          python << 'SCRIPT'
          import paramiko
          import os

          host = os.environ['SFTP_HOST']
          username = os.environ['SFTP_USERNAME']
          password = os.environ['SFTP_PASSWORD']

          print(f"Connecting to {host}...")
          transport = paramiko.Transport((host, 22))
          transport.connect(username=username, password=password)
          sftp = paramiko.SFTPClient.from_transport(transport)

          remote_path = "/incoming/src/feedonomics/catalog/google_products_ns-company_en_US.csv"
          local_path = "google_products_ns-company_en_US.csv"

          print(f"Downloading {remote_path}...")
          sftp.get(remote_path, local_path)

          sftp.close()
          transport.close()

          size = os.path.getsize(local_path)
          print(f"Downloaded: {size / 1024 / 1024:.2f} MB")
          SCRIPT
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USERNAME: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}

      - name: Upload to Render app
        run: |
          echo "Uploading to Render..."
          curl -X POST \
            -F "file=@google_products_ns-company_en_US.csv" \
            "${{ secrets.RENDER_APP_URL }}/api/upload" \
            --fail --show-error

          echo "Upload complete!"
